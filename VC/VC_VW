SELECT
cd.C_EmailAddress as EmailAddress

FROM [Data_Consumer_Load] cd
INNER JOIN [Data_Consumer_ActiveEmails] a
on  cd.C_EmailAddress = a.EmailAddress
INNER JOIN [Eloqua_PrimaryEmails] p
on  cd.C_EmailAddress = p.EmailAddress
INNER JOIN [CDP_GR_Individual_Preferences] pref
ON cd.C_EmailAddress = pref.email_address
LEFT JOIN [Eloqua_Feed_Claim_History] ch
on  cd.C_EmailAddress = ch.[Email Address]
LEFT JOIN [Eloqua_Feed_Claim] cc
on  cd.C_EmailAddress = cc.[Subscriber Email]
LEFT JOIN VW_Zips vwz
ON vwz.Zip = cd.C_Zip_Postal
LEFT JOIN [CDP_GR_Individual] cdp
ON cd.C_EmailAddress = cdp.email_address

WHERE
vwz.Zip IS NOT NULL

AND
cd.C_Email_Source_Code1 = 'P'

AND
pref.Opt_In_VC_Retail = '1'

AND
( /*Is OON*/
  (ch.SFMCClaimRelationship = 'Member'
  AND
  ch.SFMCClaimOON = 'Y')

  OR /*Is NOC*/
  ch.[Email Address] IS NULL
  
  OR /*Is INN*/
  (ch.SFMCClaimOON = '' OR ch.SFMCClaimOON IS NULL
    AND NOT
    (cdp.last_claim_frame_provider_categorization = 'Gold'
    OR cdp.last_claim_frame_provider_categorization = 'Platinum'
    OR cdp.last_claim_lens_provider_categorization = 'Gold'
    OR cdp.last_claim_lens_provider_categorization = 'Platinum'
    OR cdp.last_claim_contact_lens_provider_categorization = 'Gold'
    OR cdp.last_claim_contact_lens_provider_categorization = 'Platinum'
    OR cdp.last_claim_exam_provider_categorization = 'Gold'
    OR cdp.last_claim_exam_provider_categorization = 'Platinum')
  )
)

AND /*Is Eligible*/
ch.SFMCClaimEligible = '' OR ch.SFMCClaimEligible IS NULL

AND /*SA*/
cd.C_Strategic_Alliance_Code1 IS NULL

AND /*Savings Pass*/
cd.C_Vision_Savings_Pass1 = '0'

AND NOT  /*-----------------Global Opt Out------------------*/
(
EXISTS 
(SELECT client_id 
FROM [Ex_VC_Global_Client_Opt_Out] gopt
WHERE  cd.C_Client_ID1 = gopt.client_id)
)

AND NOT  /*-----------------Strategic Alliances except PE------------------*/
(
EXISTS 
(SELECT ClientID 
FROM [Ex_VC_Not_Eligible20] ne
WHERE  cd.C_Client_ID1 = ne.ClientID)
)

AND NOT  /*-----------------Claimed this year------------------*/
(
EXISTS 
(SELECT cc.[Subscriber Email] 
FROM [Eloqua_Feed_Claim] cc
WHERE  cd.C_EmailAddress = cc.[Subscriber Email])
)

AND NOT  /*-----------------Opt Out SF------------------*/
EXISTS 
(SELECT email_address 
FROM [CDP_GR_Individual_Preferences] pref
WHERE  cd.C_EmailAddress = pref.email_address
AND pref.Opt_In_VC_Retail = 0
)

AND NOT /*-----------------Opt Out MP-----------------*/
EXISTS 
(SELECT mp.Email_Address
FROM [VC_Subscription_Form_Page_Prod] mp
WHERE  cd.C_EmailAddress = mp.Email_Address
AND Retail_Optin = 0)

AND NOT /*-----------------VW Website Opt Outs------------------*/
EXISTS 
(SELECT email_address 
FROM [Ex_VW_Website_Optouts] vw
WHERE  cd.C_EmailAddress = vw.Email_Address )
